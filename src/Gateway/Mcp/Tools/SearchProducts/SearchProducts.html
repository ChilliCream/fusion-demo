<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Catalog</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 0;
            background: transparent;
            color: var(--text);
            line-height: 1.5;
        }
        :root {
            --text: #374151;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --primary: #10a37f;
            --primary-hover: #0d8a6b;
            --success: #10a37f;
            --surface: #ffffff;
            --surface-hover: #f9fafb;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --text: #ececec;
                --text-secondary: #9b9b9b;
                --border: #2f2f2f;
                --primary: #10a37f;
                --primary-hover: #0d8a6b;
                --success: #10a37f;
                --surface: #212121;
                --surface-hover: #2a2a2a;
            }
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
        }
        .product-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .product-card:hover {
            border-color: var(--primary);
        }
        .product-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        .product-content {
            padding: 12px;
        }
        .product-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
        }
        .price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .stock-indicator {
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        button {
            width: 100%;
            padding: 8px 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
            font-size: 14px;
        }
        button:hover:not(:disabled) {
            background: var(--primary-hover);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.loading {
            pointer-events: none;
        }
        button.success {
            background: var(--success);
        }
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="products" class="products-grid"></div>
    <script>
        (function() {
            console.log('[SearchProducts] Widget script initializing at', new Date().toISOString());
            let products = [];
            let isLoading = true;
            let eventCount = 0;

            // Log all events for debugging
            window.addEventListener('openai:set_globals', (e) => {
                eventCount++;
                console.log(`[SearchProducts] ========== Event #${eventCount} fired at ${new Date().toISOString()} ==========`);
                console.log(`[SearchProducts] Event #${eventCount} toolOutput:`, e.detail?.globals?.toolOutput);
                console.log(`[SearchProducts] Event #${eventCount} widget.props.data:`, e.detail?.globals?.widget?.props?.data);
            }, { passive: true, capture: true });

            function getProductsFromGlobals(globals) {
                if (!globals) {
                    return [];
                }

                // Check widget.props.data structure (GraphQL)
                const widgetPropsData = globals.widget?.props?.data;

                if (widgetPropsData?.products?.nodes) {
                    return widgetPropsData.products.nodes;
                }

                // Check toolOutput structure
                const toolOutput = globals.toolOutput;

                if (toolOutput?.data?.products?.nodes) {
                    return toolOutput.data.products.nodes;
                }

                if (toolOutput?.data?.products && Array.isArray(toolOutput.data.products)) {
                    return toolOutput.data.products;
                }

                if (toolOutput?.result && Array.isArray(toolOutput.result)) {
                    return toolOutput.result;
                }

                return [];
            }

            function render() {
                console.log('[SearchProducts] render() called with products:', products);
                console.log('[SearchProducts] products.length:', products?.length);
                const container = document.getElementById('products');

                if (!container) {
                    console.log('[SearchProducts] Container not found');
                    return;
                }

                // Show loading state while waiting for data
                if (isLoading) {
                    console.log('[SearchProducts] Rendering loading state');
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;"><span class="spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-top-color: #666; border-radius: 50%; animation: spin 0.6s linear infinite;"></span> <span style="margin-left: 8px;">Loading products...</span></div>';
                    return;
                }

                if (!Array.isArray(products) || products.length === 0) {
                    console.log('[SearchProducts] No products, showing empty state');
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
                    return;
                }

                console.log('[SearchProducts] Rendering', products.length, 'products');

                // Generate a consistent emoji for each product based on its name
                const getProductEmoji = (name) => {
                    const emojis = {
                        'chair': 'ðŸª‘',
                        'armchair': 'ðŸ›‹ï¸',
                        'dining': 'ðŸ½ï¸',
                        'rocking': 'ðŸª‘',
                        'table': 'ðŸªµ',
                        'sofa': 'ðŸ›‹ï¸',
                        'couch': 'ðŸ›‹ï¸',
                        'desk': 'ðŸªµ',
                        'bed': 'ðŸ›ï¸'
                    };
                    const lowerName = name.toLowerCase();
                    for (const [key, emoji] of Object.entries(emojis)) {
                        if (lowerName.includes(key)) return emoji;
                    }
                    return 'ðŸª‘';
                };

                container.innerHTML = products.map(product => `
                    <div class="product-card">
                        <div class="product-image" style="${product.pictureUrl ? 'background: none; padding: 0;' : ''}">
                            ${product.pictureUrl
                                ? `<img src="${product.pictureUrl}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">`
                                : getProductEmoji(product.name)}
                        </div>
                        <div class="product-content">
                            <div class="product-name">${product.name}</div>
                            <div class="price">$${product.price.toFixed(2)}</div>
                            <div class="stock-indicator" style="color: ${product.availableQuantity > 0 ? 'var(--success)' : '#ef4444'};">
                                <span>${product.availableQuantity > 0 ? 'âœ“' : 'âœ—'}</span>
                                <span>${product.availableQuantity > 0 ? `${product.availableQuantity} in stock` : 'Out of stock'}</span>
                            </div>
                            <button
                                class="add-to-cart-btn"
                                data-product-id="${product.id}"
                                data-available-quantity="${product.availableQuantity}"
                                ${product.availableQuantity === 0 ? 'disabled' : ''}>
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add click event listeners
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (this.classList.contains('loading')) {
                            return;
                        }

                        const productId = this.getAttribute('data-product-id');
                        const originalText = this.innerHTML;
                        const stockIndicator = this.parentElement.querySelector('.stock-indicator');
                        let currentQuantity = parseInt(this.getAttribute('data-available-quantity'));

                        try {
                            // Show loading state
                            this.classList.add('loading');
                            this.disabled = true;
                            this.innerHTML = '<span class="spinner"></span>Adding...';

                            if (window.openai?.callTool) {
                                const result = await window.openai.callTool('AddProductToShoppingBasket', {
                                    productId: productId,
                                    quantity: 1
                                });

                                // Optimistically update quantity
                                currentQuantity -= 1;
                                this.setAttribute('data-available-quantity', currentQuantity);

                                if (currentQuantity > 0) {
                                    stockIndicator.style.color = 'var(--success)';
                                    stockIndicator.textContent = `âœ“ ${currentQuantity} in stock`;
                                } else {
                                    stockIndicator.style.color = '#dc3545';
                                    stockIndicator.textContent = 'âœ— Out of stock';
                                }

                                // Show success state
                                this.classList.remove('loading');
                                this.classList.add('success');
                                this.innerHTML = 'âœ“ Added to Cart!';

                                // Reset button after 2 seconds
                                setTimeout(() => {
                                    this.classList.remove('success');

                                    if (currentQuantity > 0) {
                                        this.disabled = false;
                                        this.innerHTML = originalText;
                                    } else {
                                        this.disabled = true;
                                        this.innerHTML = 'Out of Stock';
                                        this.style.opacity = '0.5';
                                        this.style.cursor = 'not-allowed';
                                    }
                                }, 2000);
                            }
                        } catch (err) {
                            // Show error state
                            this.classList.remove('loading');
                            this.innerHTML = 'âœ— Failed';
                            this.style.background = '#dc3545';

                            // Reset button after 2 seconds
                            setTimeout(() => {
                                this.disabled = false;
                                this.style.background = '';
                                this.innerHTML = originalText;
                            }, 2000);
                        }
                    });
                });
            }

            // Handle the openai:set_globals event
            const handleSetGlobals = (event) => {
                console.log('[SearchProducts] handleSetGlobals called');
                const globals = event.detail?.globals;

                if (!globals) {
                    console.log('[SearchProducts] No globals, returning');
                    return;
                }

                console.log('[SearchProducts] Full globals:', JSON.stringify(globals, null, 2));

                // Extract products from the globals
                const extractedProducts = getProductsFromGlobals(globals);
                console.log('[SearchProducts] Extracted products:', extractedProducts);
                console.log('[SearchProducts] Products count:', extractedProducts.length);

                products = extractedProducts;

                // Only mark as loaded if we have actual data (toolOutput has data or we extracted products)
                // This prevents the initial null event from hiding the loading state
                if (globals.toolOutput?.data || globals.widget?.props?.data?.products || extractedProducts.length > 0) {
                    console.log('[SearchProducts] Marking as loaded - have actual data');
                    isLoading = false;
                } else {
                    console.log('[SearchProducts] No data yet, keeping loading state');
                }

                // Render the products
                console.log('[SearchProducts] Calling render with', products.length, 'products');
                render();
            };

            // Listen for the event
            window.addEventListener('openai:set_globals', handleSetGlobals, {
                passive: true,
            });

            // Initial render
            render();
        })();
    </script>
</body>
</html>
