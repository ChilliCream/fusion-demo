name: Frontend Release

on:
  push:
    branches: [main]
    paths:
      - "src/frontend/**"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch: {}

jobs:
  build-publish-deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-frontend
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Compute image tag
        id: meta
        run: |
          TS=$(date -u +'%Y%m%dT%H%M%SZ')
          SHORTSHA=${GITHUB_SHA::7}
          echo "tag=${TS}-${SHORTSHA}" >> $GITHUB_OUTPUT
          echo "image=${{ secrets.ACR_LOGIN_SERVER }}/ccc-eu1-demo-ca-frontend:${TS}-${SHORTSHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        working-directory: src/frontend
        run: |
          docker build \
            --build-arg VITE_GRAPHQL_ENDPOINT=${{ vars.GRAPHQL_ENDPOINT }} \
            -t ${{ steps.meta.outputs.image }} \
            .
          docker push ${{ steps.meta.outputs.image }}

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          containerAppName: ccc-eu1-demo-ca-frontend
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          imageToDeploy: ${{ steps.meta.outputs.image }}
          containerAppEnvironment: ${{ secrets.CONTAINERAPPS_ENVIRONMENT }}
          targetPort: 8080
          ingress: external
          registryUrl: ${{ secrets.ACR_LOGIN_SERVER }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}
