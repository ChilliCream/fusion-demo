name: Gateway API Release

on:
  push:
    branches: [main]
    paths:
      - "src/Gateway/**"
      - "src/Defaults/**"
      - ".github/workflows/deploy-gateway.yml"
      - "Directory.Packages.props"
  workflow_dispatch: {}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Compute image tag
        id: meta
        run: |
          TS=$(date -u +'%Y%m%dT%H%M%SZ')
          SHORTSHA=${GITHUB_SHA::7}
          echo "tag=${TS}-${SHORTSHA}" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET 10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login (for dotnet publish push)
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # Build .NET app and publish directly to an OCI image, then push to ACR.
      - name: dotnet publish -> container (push to ACR)
        working-directory: src/Gateway
        run: |
          dotnet restore
          dotnet publish -c Release \
            -p:ContainerRepository=ccc-eu1-demo-ca-gateway \
            -p:ContainerImageTag=${{ needs.prepare.outputs.tag }} \
            -p:ContainerRegistry=${{ secrets.ACR_LOGIN_SERVER }} \
            -p:PublishAot=true \
            -p:RuntimeIdentifier=linux-x64

      - name: Upload OpenAPI collection
        run: |
          # Equivalent to `dotnet nitro openapi upload ...`
          dotnet tool exec ChilliCream.Nitro.CommandLine --prerelease --yes -- openapi upload \
            --pattern "src/Gateway/OpenApi/*.graphql" \
            --tag ${{ needs.prepare.outputs.tag }} \
            --openapi-collection-id "" \
            --api-key ${{ secrets.NITRO_API_KEY }}

  deploy:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    concurrency:
      group: deploy-gateway
      cancel-in-progress: false

    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create or Update App Service
        run: |
          # Create the web app if it doesn't exist
          if ! az webapp show --name ccc-eu1-demo-ca-gateway --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} &> /dev/null; then
            echo "Creating new App Service: ccc-eu1-demo-ca-gateway"
            az webapp create \
              --name ccc-eu1-demo-ca-gateway \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --plan ${{ secrets.APP_SERVICE_PLAN }} \
              --deployment-container-image-name ${{ secrets.ACR_LOGIN_SERVER }}/ccc-eu1-demo-ca-gateway:${{ needs.prepare.outputs.tag }}
          fi

          # Configure container settings
          az webapp config container set \
            --name ccc-eu1-demo-ca-gateway \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --container-image-name ${{ secrets.ACR_LOGIN_SERVER }}/ccc-eu1-demo-ca-gateway:${{ needs.prepare.outputs.tag }} \
            --container-registry-url https://${{ secrets.ACR_LOGIN_SERVER }} \
            --container-registry-user ${{ secrets.ACR_USERNAME }} \
            --container-registry-password ${{ secrets.ACR_PASSWORD }}

          # Configure the exposed port
          az webapp config appsettings set \
            --name ccc-eu1-demo-ca-gateway \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings WEBSITES_PORT=8080

          # Enable continuous deployment from ACR
          az webapp deployment container config \
            --name ccc-eu1-demo-ca-gateway \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --enable-cd true

          # Restart the app to apply changes
          az webapp restart \
            --name ccc-eu1-demo-ca-gateway \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

      - name: Publish OpenAPI collection
        run: |
          # Equivalent to `dotnet nitro openapi publish ...`
          dotnet tool exec ChilliCream.Nitro.CommandLine --prerelease --yes -- openapi publish \
            --openapi-collection-id "" \
            --tag ${{ needs.prepare.outputs.tag }} \
            --stage ${{ secrets.NITRO_STAGE }} \
            --openapi-collection-id "" \
            --api-key ${{ secrets.NITRO_API_KEY }}
