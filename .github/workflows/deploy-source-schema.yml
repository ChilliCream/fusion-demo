name: deploy-source-schema

on:
  workflow_call:
    inputs:
      app_name:
        description: Name of the App Service + repo path in ACR
        required: true
        type: string
      project_path:
        description: Path to the .csproj folder
        required: true
        type: string
      container_port:
        description: App port exposed in the container
        required: false
        type: number
        default: 8080
      schema_file:
        description: Source Schema File
        required: true
        type: string
    secrets:
      AZURE_CREDENTIALS: { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }
      AZURE_RESOURCE_GROUP: { required: true }
      APP_SERVICE_PLAN: { required: true }
      ACR_LOGIN_SERVER: { required: true }
      ACR_USERNAME: { required: true }
      ACR_PASSWORD: { required: true }
      NITRO_API_KEY: { required: true }
      NITRO_API_ID: { required: true }
      NITRO_STAGE: { required: true }

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      image: ${{ steps.meta.outputs.image }}
    steps:
      - name: Compute image tag
        id: meta
        run: |
          TS=$(date -u +'%Y%m%dT%H%M%SZ')
          SHORTSHA=${GITHUB_SHA::7}
          VERSION=${{ inputs.app_name }}-${SHORTSHA}
          echo "tag=${TS}-${SHORTSHA}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "image=${{ secrets.ACR_LOGIN_SERVER }}/${{ inputs.app_name }}:${TS}-${SHORTSHA}" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: version

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET 10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login (for dotnet publish push)
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # Build .NET app and publish directly to an OCI image, then push to ACR.
      - name: dotnet publish -> container (push to ACR)
        working-directory: ${{ inputs.project_path }}
        run: |
          dotnet restore
          dotnet publish -c Release \
            -p:PublishProfile=DefaultContainer \
            -p:ContainerRepository=${{ inputs.app_name }} \
            -p:ContainerImageTag=${{ needs.version.outputs.tag }} \
            -p:ContainerRegistry=${{ secrets.ACR_LOGIN_SERVER }} \
            -p:ContainerPort=${{ inputs.container_port }} \
            -p:ContainerBaseImage=mcr.microsoft.com/dotnet/aspnet:10.0

      - name: Export Source Schema
        working-directory: ${{ inputs.project_path }}
        run: dotnet run -- schema export

      - name: Upload Source Schema
        working-directory: ${{ inputs.project_path }}
        run: |
          # Equivalent to `dotnet nitro fusion upload ...`
          dotnet tool exec ChilliCream.Nitro.CommandLine --prerelease --yes -- fusion upload \
            --source-schema-file "${{ inputs.schema_file }}" \
            --tag ${{ needs.version.outputs.version }} \
            --api-id ${{ secrets.NITRO_API_ID }} \
            --api-key ${{ secrets.NITRO_API_KEY }} \

  deploy:
    runs-on: ubuntu-latest
    needs: [version, build]
    concurrency:
      group: deploy-${{ inputs.app_name }}
      cancel-in-progress: false

    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create or Update App Service
        run: |
          # Create the web app if it doesn't exist
          if ! az webapp show --name ${{ inputs.app_name }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} &> /dev/null; then
            echo "Creating new App Service: ${{ inputs.app_name }}"
            az webapp create \
              --name ${{ inputs.app_name }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --plan ${{ secrets.APP_SERVICE_PLAN }} \
              --deployment-container-image-name ${{ needs.version.outputs.image }}
          fi

          # Configure container settings
          az webapp config container set \
            --name ${{ inputs.app_name }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --container-image-name ${{ needs.version.outputs.image }} \
            --container-registry-url https://${{ secrets.ACR_LOGIN_SERVER }} \
            --container-registry-user ${{ secrets.ACR_USERNAME }} \
            --container-registry-password ${{ secrets.ACR_PASSWORD }}

          # Configure the exposed port
          az webapp config appsettings set \
            --name ${{ inputs.app_name }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings WEBSITES_PORT=${{ inputs.container_port }}

          # Enable continuous deployment from ACR
          az webapp deployment container config \
            --name ${{ inputs.app_name }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --enable-cd true

          # Restart the app to apply changes
          az webapp restart \
            --name ${{ inputs.app_name }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

      - name: Publish Gateway Schema
        run: |
          # Equivalent to `dotnet nitro fusion publish ...`
          dotnet tool exec ChilliCream.Nitro.CommandLine --prerelease --yes --fusion publish \
            --source-schema ${{ inputs.app_name }}
            --tag ${{ needs.version.outputs.version }} \
            --stage ${{ secrets.NITRO_STAGE }} \
            --api-id ${{ secrets.NITRO_API_ID }} \
            --api-key ${{ secrets.NITRO_API_KEY }} \
